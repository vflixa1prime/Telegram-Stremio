{% extends "base.html" %}
{% block title %}Access Management{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-3xl font-bold text-primary">üîë Access Management</h2>
            <p class="text-sm text-text opacity-60 mt-1">Manage API tokens for Stremio addon access</p>
        </div>
        <button onclick="loadTokens()"
            class="bg-primary text-white px-4 py-2 rounded-lg hover:opacity-80 transition text-sm font-medium">
            üîÑ Refresh
        </button>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="theme-card rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-primary" id="stat-total">‚Äì</div>
            <div class="text-xs text-text opacity-60 mt-1">Total Tokens</div>
        </div>
        <div class="theme-card rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-green-500" id="stat-active">‚Äì</div>
            <div class="text-xs text-text opacity-60 mt-1">Active</div>
        </div>
        <div class="theme-card rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-red-400" id="stat-expired">‚Äì</div>
            <div class="text-xs text-text opacity-60 mt-1">Expired / No Sub</div>
        </div>
    </div>

    <!-- Search & Filter bar -->
    <div class="flex flex-wrap gap-3 mb-4 items-center">
        <input id="search-input" type="text" placeholder="üîç Search by name or user ID‚Ä¶"
            class="flex-1 min-w-[200px] border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-primary bg-white dark:bg-gray-800 text-text"
            oninput="renderPage()">
        <select id="filter-status"
            class="border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none bg-white dark:bg-gray-800 text-text"
            onchange="renderPage()">
            <option value="all">All Status</option>
            <option value="active">üü¢ Active</option>
            <option value="expired">üî¥ Expired</option>
        </select>
        <select id="page-size"
            class="border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none bg-white dark:bg-gray-800 text-text"
            onchange="currentPage=1; renderPage()">
            <option value="10">10 / page</option>
            <option value="25">25 / page</option>
            <option value="50">50 / page</option>
        </select>
    </div>

    <!-- Token Table -->
    <div class="theme-card rounded-2xl shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200 dark:border-gray-700">
                        <th class="px-4 py-3 text-left text-text opacity-70 font-semibold">Status</th>
                        <th class="px-4 py-3 text-left text-text opacity-70 font-semibold">User</th>
                        <th class="px-4 py-3 text-left text-text opacity-70 font-semibold">Addon Link</th>
                        <th class="px-4 py-3 text-left text-text opacity-70 font-semibold">Created</th>
                        <th class="px-4 py-3 text-left text-text opacity-70 font-semibold">Expires</th>
                        <th class="px-4 py-3 text-center text-text opacity-70 font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody id="token-table-body">
                    <tr>
                        <td colspan="6" class="text-center py-10 text-text opacity-40">Loading tokens‚Ä¶</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div class="flex items-center justify-between mt-4 text-sm text-text opacity-70" id="pagination-bar">
        <span id="page-info"></span>
        <div class="flex gap-2">
            <button id="btn-prev" onclick="changePage(-1)"
                class="px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 disabled:opacity-30 transition">‚Äπ
                Prev</button>
            <span id="page-num" class="px-3 py-1 font-semibold"></span>
            <button id="btn-next" onclick="changePage(1)"
                class="px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 disabled:opacity-30 transition">Next
                ‚Ä∫</button>
        </div>
    </div>
</div>

<!-- Assign Plan Modal -->
<div id="assign-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50"
    style="display:none">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md shadow-2xl mx-4">
        <h3 class="text-lg font-bold mb-1 text-gray-800 dark:text-white">üìã Assign Subscription Plan</h3>
        <p class="text-sm text-gray-500 mb-4" id="assign-user-label">User: ‚Äì</p>
        <input type="hidden" id="assign-user-id">

        <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Select a Plan</label>
            <select id="assign-plan-select"
                class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="">‚Äî Select plan ‚Äî</option>
            </select>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Or enter custom
                days</label>
            <input type="number" id="assign-custom-days" placeholder="e.g. 30" min="1"
                class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <p class="text-xs text-gray-400 mt-1">Custom days override plan selection above.</p>
        </div>

        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeAssignModal()"
                class="px-4 py-2 text-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition text-sm">Cancel</button>
            <button onclick="assignPlan()"
                class="px-4 py-2 bg-primary text-white rounded-lg hover:opacity-80 transition text-sm font-semibold">‚úÖ
                Assign & Activate</button>
        </div>
    </div>
</div>

<script>
    let allTokens = [];
    let currentPage = 1;

    function getFiltered() {
        const q = document.getElementById('search-input').value.toLowerCase();
        const status = document.getElementById('filter-status').value;
        return allTokens.filter(t => {
            const matchQ = !q ||
                (t.user_name && t.user_name.toLowerCase().includes(q)) ||
                (t.user_id && String(t.user_id).includes(q));
            const matchStatus = status === 'all' || (status === 'active' && !t.is_expired) || (status === 'expired' && t.is_expired);
            return matchQ && matchStatus;
        });
    }

    function renderPage() {
        const filtered = getFiltered();
        const pageSize = parseInt(document.getElementById('page-size').value);
        const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
        if (currentPage > totalPages) currentPage = totalPages;

        const start = (currentPage - 1) * pageSize;
        const slice = filtered.slice(start, start + pageSize);

        document.getElementById('page-info').textContent = `Showing ${start + 1}‚Äì${Math.min(start + pageSize, filtered.length)} of ${filtered.length}`;
        document.getElementById('page-num').textContent = `Page ${currentPage} / ${totalPages}`;
        document.getElementById('btn-prev').disabled = currentPage <= 1;
        document.getElementById('btn-next').disabled = currentPage >= totalPages;

        const tbody = document.getElementById('token-table-body');
        if (!slice.length) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-10 text-text opacity-40">No tokens match your search.</td></tr>';
            return;
        }
        tbody.innerHTML = slice.map(renderRow).join('');
    }

    function renderRow(t) {
        const statusBadge = t.is_expired
            ? '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-600">üî¥ Expired</span>'
            : '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">üü¢ Active</span>';

        // User column ‚Äî show name or fallback to Telegram User (ID: X)
        const displayName = t.user_name || (t.user_id ? `Telegram User` : 'Unknown');
        const nameHtml = `<div class="font-medium text-text">${escHtml(displayName)}</div>`;
        const idHtml = t.user_id ? `<div class="text-xs text-text opacity-50">ID: ${t.user_id}</div>` : '';

        const addonLink = !t.has_token
            ? `<span class="px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-700">‚ö†Ô∏è No Token Yet</span>
         <div class="text-xs text-text opacity-40 italic mt-1">User hasn't generated addon token via bot.</div>`
            : t.is_expired
                ? `<div>
           <span class="px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-600">üî¥ Subscription Expired</span>
           <div class="text-xs text-text opacity-40 italic mt-1">${t.user_found ? 'Subscription inactive/expired' : 'No subscription record'}</div>
           ${t.addon_url ? `<button onclick="copyLink('${escHtml(t.addon_url)}')" class="text-xs text-text opacity-30 hover:opacity-60 underline mt-0.5">Copy URL (admin)</button>` : ''}
         </div>`
                : (t.addon_url
                    ? `<button onclick="copyLink('${escHtml(t.addon_url)}')" class="text-primary hover:underline text-xs">üìã Copy Install Link</button>`
                    : '‚Äî');

        const expires = t.expires_at
            ? `<span class="${t.is_expired ? 'text-red-500 font-semibold' : ''}">${fmtDate(t.expires_at)}</span>`
            : '<span class="text-red-400 text-xs italic">No expiry</span>';

        const rowCls = t.is_expired ? 'bg-red-50 dark:bg-red-900/10' : '';
        const safeName = escHtml(t.user_name || String(t.user_id || ''));

        // --- Action buttons ---
        let actionBtns = '';
        if (t.user_id) {
            // Full actions for linked tokens/subscribers
            actionBtns = `
            <button onclick="openAssignModal(${t.user_id}, '${safeName}')"
              class="text-blue-500 hover:text-blue-700 text-xs px-2 py-1 rounded border border-blue-300 hover:bg-blue-50 transition mb-1 mr-1">
              üìÖ Assign
            </button>
            <button onclick="openSubModal(${t.user_id}, '${safeName}', 'extend')"
              class="text-green-600 hover:text-green-800 text-xs px-2 py-1 rounded border border-green-300 hover:bg-green-50 transition mb-1 mr-1">
              ‚ûï Extend
            </button>
            <button onclick="openSubModal(${t.user_id}, '${safeName}', 'reduce')"
              class="text-yellow-600 hover:text-yellow-800 text-xs px-2 py-1 rounded border border-yellow-300 hover:bg-yellow-50 transition mb-1 mr-1">
              ‚ûñ Reduce
            </button>
            <button onclick="openSubModal(${t.user_id}, '${safeName}', 'delete')"
              class="text-red-500 hover:text-red-700 text-xs px-2 py-1 rounded border border-red-300 hover:bg-red-50 transition mb-1 mr-1">
              üö´ Revoke
            </button>`;
        } else if (t.token) {
            // Orphan token ‚Äî show Link User button
            actionBtns = `
            <button onclick="linkUser('${escHtml(t.token)}')"
              class="text-purple-600 hover:text-purple-800 text-xs px-3 py-1 rounded border border-purple-300 hover:bg-purple-50 transition mb-1 font-semibold">
              üîó Link User ID
            </button>
            <div class="text-xs text-text opacity-40 italic mt-0.5 w-full">Enter Telegram user_id to enable management</div>`;
        }

        const revokeTokenBtn = t.token ? `
            <button onclick="revokeToken('${escHtml(t.token)}')"
              class="text-gray-500 hover:text-red-700 text-xs px-2 py-1 rounded border border-gray-300 hover:bg-red-50 transition mb-1">
              üóë Del Token
            </button>` : '';

        return `<tr class="border-b border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/30 transition ${rowCls}">
      <td class="px-4 py-3">${statusBadge}</td>
      <td class="px-4 py-3">${nameHtml}${idHtml}</td>
      <td class="px-4 py-3">${addonLink}</td>
      <td class="px-4 py-3 text-text opacity-70 text-xs">${t.created_at ? fmtDate(t.created_at) : '‚Äî'}</td>
      <td class="px-4 py-3 text-xs">${expires}</td>
      <td class="px-4 py-3">
        <div class="flex flex-wrap gap-1">${actionBtns}${revokeTokenBtn}</div>
      </td>
    </tr>`;
    }

    function changePage(dir) {
        currentPage += dir;
        renderPage();
    }

    async function loadTokens() {
        const tbody = document.getElementById('token-table-body');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-10 text-text opacity-40">Loading‚Ä¶</td></tr>';
        try {
            const resp = await fetch('/api/admin/access/tokens');
            const data = await resp.json();
            allTokens = data.tokens || [];

            document.getElementById('stat-total').textContent = allTokens.length;
            document.getElementById('stat-active').textContent = allTokens.filter(t => !t.is_expired).length;
            document.getElementById('stat-expired').textContent = allTokens.filter(t => t.is_expired).length;

            currentPage = 1;
            renderPage();
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-red-500">Error: ${err.message}</td></tr>`;
        }
    }

    async function loadPlans() {
        try {
            const resp = await fetch('/api/admin/subscriptions/plans');
            const data = await resp.json();
            const plans = data.plans || data || [];
            const sel = document.getElementById('assign-plan-select');
            sel.innerHTML = '<option value="">‚Äî Select a plan ‚Äî</option>' +
                plans.map(p => `<option value="${p.days}">${p.days} days${p.price ? ' ‚Äî ‚Çπ' + p.price : ''}</option>`).join('');
        } catch (e) { console.warn('Could not load plans', e); }
    }

    function openAssignModal(userId, userName) {
        document.getElementById('assign-user-id').value = userId;
        document.getElementById('assign-user-label').textContent = `User: ${userName} (ID: ${userId})`;
        document.getElementById('assign-custom-days').value = '';
        document.getElementById('assign-plan-select').value = '';
        const modal = document.getElementById('assign-modal');
        modal.style.display = 'flex';
    }

    function closeAssignModal() {
        document.getElementById('assign-modal').style.display = 'none';
    }

    async function assignPlan() {
        const userId = parseInt(document.getElementById('assign-user-id').value);
        const customDays = parseInt(document.getElementById('assign-custom-days').value) || 0;
        const planDays = parseInt(document.getElementById('assign-plan-select').value) || 0;
        const days = customDays || planDays;

        if (!days || days < 1) { showToast('Please select a plan or enter custom days.', 'red'); return; }

        try {
            const resp = await fetch(`/api/admin/access/users/${userId}/assign-plan`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ days })
            });
            const data = await resp.json();
            if (resp.ok) {
                showToast(`‚úÖ Assigned ${days} days to user ${userId}`, 'green');
                closeAssignModal();
                loadTokens();
            } else {
                showToast(data.detail || 'Failed to assign plan.', 'red');
            }
        } catch (err) { showToast('Error: ' + err.message, 'red'); }
    }

    async function revokeToken(token) {
        if (!confirm('Delete this token? The user will lose addon access immediately.')) return;
        try {
            const resp = await fetch(`/api/admin/access/tokens/${encodeURIComponent(token)}`, { method: 'DELETE' });
            const data = await resp.json();
            if (resp.ok) { showToast('Token deleted.', 'green'); loadTokens(); }
            else showToast(data.detail || 'Failed.', 'red');
        } catch (err) { showToast('Error: ' + err.message, 'red'); }
    }

    async function linkUser(token) {
        const userId = prompt('Enter the Telegram User ID to link this token to:');
        if (!userId || isNaN(parseInt(userId))) { showToast('Invalid user ID.', 'red'); return; }
        try {
            const resp = await fetch(`/api/admin/access/tokens/${encodeURIComponent(token)}/link-user`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: parseInt(userId) })
            });
            const data = await resp.json();
            if (resp.ok) {
                showToast(`‚úÖ Token linked to user ${userId}. Refreshing‚Ä¶`, 'green');
                loadTokens();
            } else { showToast(data.detail || 'Failed to link.', 'red'); }
        } catch (err) { showToast('Error: ' + err.message, 'red'); }
    }

    // Sub action modal (Extend / Reduce / Revoke)
    function openSubModal(userId, userName, action) {
        document.getElementById('sub-action-user-id').value = userId;
        document.getElementById('sub-action-action').value = action;
        const titles = { extend: '‚ûï Extend Subscription', reduce: '‚ûñ Reduce Subscription', delete: 'üö´ Revoke Subscription' };
        const descs = {
            extend: `Add days to <b>${userName}</b>'s subscription.`,
            reduce: `Remove days from <b>${userName}</b>'s subscription.`,
            delete: `<b>Warning:</b> Revoke <b>${userName}</b>'s subscription entirely.`
        };
        document.getElementById('sub-action-title').textContent = titles[action];
        document.getElementById('sub-action-desc').innerHTML = descs[action];
        document.getElementById('sub-action-days-group').className = action === 'delete' ? 'hidden' : 'mb-4';
        document.getElementById('sub-action-days').value = 30;
        const btn = document.getElementById('sub-action-btn');
        btn.className = `px-4 py-2 rounded-lg text-white text-sm font-semibold transition hover:opacity-80 ${action === 'delete' ? 'bg-red-500' : action === 'reduce' ? 'bg-yellow-500' : 'bg-green-600'}`;
        document.getElementById('sub-action-modal').style.display = 'flex';
    }

    function closeSubModal() { document.getElementById('sub-action-modal').style.display = 'none'; }

    async function submitSubAction() {
        const userId = parseInt(document.getElementById('sub-action-user-id').value);
        const action = document.getElementById('sub-action-action').value;
        const days = parseInt(document.getElementById('sub-action-days').value) || 0;
        try {
            const resp = await fetch(`/api/admin/subscriptions/users/${userId}/manage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, days })
            });
            const data = await resp.json();
            if (resp.ok) {
                showToast(`‚úÖ ${action.charAt(0).toUpperCase() + action.slice(1)}d subscription for user ${userId}`, 'green');
                closeSubModal();
                loadTokens();
            } else { showToast(data.detail || 'Failed.', 'red'); }
        } catch (err) { showToast('Error: ' + err.message, 'red'); }
    }

    async function copyLink(url) {
        try { await navigator.clipboard.writeText(url); showToast('Link copied!', 'green'); }
        catch { prompt('Copy this link:', url); }
    }

    function fmtDate(iso) {
        if (!iso) return '‚Äî';
        const d = new Date(iso);
        return d.toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata', day: '2-digit', month: 'short', year: 'numeric' })
            + ' ' + d.toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata', hour: '2-digit', minute: '2-digit' });
    }

    function escHtml(s) {
        return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    function showToast(msg, color) {
        const t = document.createElement('div');
        t.textContent = msg;
        t.className = `fixed bottom-6 right-6 px-4 py-3 rounded-xl shadow-lg text-white text-sm z-[200] bg-${color}-500 transition-all`;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    // Close modal on backdrop click
    document.getElementById('assign-modal').addEventListener('click', function (e) {
        if (e.target === this) closeAssignModal();
    });

    loadPlans();
    loadTokens();
</script>

<!-- Sub Action Modal (Extend / Reduce / Revoke) -->
<div id="sub-action-modal" class="fixed inset-0 bg-black bg-opacity-60 items-center justify-center z-50 mx-4"
    style="display:none">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md shadow-2xl mx-auto mt-24">
        <h3 class="text-lg font-bold mb-1 text-gray-800 dark:text-white" id="sub-action-title">Manage Subscription</h3>
        <p class="text-sm text-gray-500 mb-4" id="sub-action-desc"></p>
        <input type="hidden" id="sub-action-user-id">
        <input type="hidden" id="sub-action-action">
        <div id="sub-action-days-group" class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Number of Days</label>
            <input type="number" id="sub-action-days" value="30" min="1"
                class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
        </div>
        <div class="flex justify-end gap-3 mt-4">
            <button onclick="closeSubModal()"
                class="px-4 py-2 text-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition text-sm">Cancel</button>
            <button id="sub-action-btn" onclick="submitSubAction()"
                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:opacity-80 transition text-sm font-semibold">Confirm</button>
        </div>
    </div>
</div>

{% endblock %}